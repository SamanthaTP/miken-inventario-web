{% extends "layout.html" %}
{% block content %}

<div class="dash">
  <div class="dash__title">
    <h2 class="dash__h2">ğŸ“Š Dashboard</h2>
    <div class="dash__sub">
      Ãšltimo reporte: {{ ultimo_reporte }}
    </div>
  </div>

  <!-- ===== TOP CARDS (como tu ejemplo) ===== -->
  <div class="dash-cards">
    <div class="dash-card dash-card--orange">
      <div class="dash-card__icon">ğŸ“¦</div>
      <div class="dash-card__label">Total Productos</div>
      <div class="dash-card__value">{{ total_productos }}</div>
    </div>

    <div class="dash-card dash-card--blue">
      <div class="dash-card__icon">ğŸ“¦</div>
      <div class="dash-card__label">Bajo Stock (Insumos)</div>
      <div class="dash-card__value">{{ bajo_insumos }}</div>
      <a class="dash-card__link" href="{{ url_for('stock_bajo') }}">âš  Ver productos bajos</a>
    </div>

    <div class="dash-card dash-card--blue2">
      <div class="dash-card__icon">ğŸ§°</div>
      <div class="dash-card__label">Bajo Stock (MÃ¡quinas)</div>
      <div class="dash-card__value">{{ bajo_maquinas }}</div>
      <a class="dash-card__link" href="{{ url_for('stock_bajo') }}">âš  Ver productos bajos</a>
    </div>

    <div class="dash-card dash-card--green">
      <div class="dash-card__icon">ğŸ’µ</div>
      <div class="dash-card__label">Caja Chica</div>
      <div class="dash-card__value">${{ "{:,.2f}".format(saldo_caja) }}</div>
      <div class="dash-card__mini">{{ "Caja abierta hoy" if caja_abierta==1 else "Caja cerrada hoy" }}</div>
    </div>

    <div class="dash-card dash-card--red">
      <div class="dash-card__icon">ğŸ””</div>
      <div class="dash-card__label">Estado Operativo</div>
      <div class="dash-card__mini">
        {{ maquinas_revision }} mÃ¡quina(s) en revisiÃ³n
      </div>
    </div>
  </div>

  <!-- ===== 3 PANELES ABAJO ===== -->
  <div class="dash-panels">
    <!-- EXISTENCIAS INSUMOS -->
    <div class="dash-panel card">
      <div class="dash-panel__head">
        <h3 class="dash-panel__title">Existencias de Insumos</h3>
        <a class="dash-panel__action" href="{{ url_for('catalogo_insumos') }}">Ver catÃ¡logo</a>
      </div>

      <div class="dash-list">
        {% set current_cat = None %}
        {% for p in insumos_rows %}
          {% if p["categoria"] != current_cat %}
            {% set current_cat = p["categoria"] %}
            <div class="dash-list__cat">{{ current_cat if current_cat else "Sin categorÃ­a" }}</div>
          {% endif %}

          <div class="dash-list__row">
            <div class="dash-list__name">
              <span class="dash-dot"></span>
              {{ p["nombre"] }}
            </div>

            <div class="dash-list__stock">
              {{ p["stock_actual"] }}
              {% if p["stock_actual"] <= p["stock_min"] %}
                <span class="dash-badge">BAJO</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}

        {% if insumos_rows|length == 0 %}
          <div class="muted">No hay insumos registrados.</div>
        {% endif %}
      </div>
    </div>

    <!-- ESTADO OPERATIVO -->
    <div class="dash-panel card">
      <div class="dash-panel__head">
        <h3 class="dash-panel__title">Estado Operativo</h3>
      </div>

      <div class="op">
        <div class="op__left">
          <div class="op__big">{{ maquinas_total }}</div>
          <div class="op__label">MÃ¡quinas</div>

          <div class="op__bullets">
            <div class="op__bullet">
              <span class="op__dot op__dot--ok"></span>
              <strong>{{ maquinas_operativas }}</strong> Operativas
            </div>
            <div class="op__bullet">
              <span class="op__dot op__dot--warn"></span>
              <strong>{{ maquinas_revision }}</strong> En revisiÃ³n
            </div>
          </div>
        </div>

        <div class="op__right">
          <div class="ring" style="--p: {{ pct_operativas }};">
            <div class="ring__center">
              <div class="ring__pct">{{ pct_operativas }}%</div>
              <div class="ring__sub">Operativas</div>
            </div>
          </div>
        </div>
      </div>

      <div class="op__hint muted">
        * â€œEn revisiÃ³nâ€ se calcula si la categorÃ­a de la mÃ¡quina contiene la palabra â€œrevisionâ€.
      </div>
    </div>

    <!-- INFORMES -->
    <div class="dash-panel card">
      <div class="dash-panel__head">
        <h3 class="dash-panel__title">Informes</h3>
      </div>

      <div class="reports">
        <a class="reports__btn" href="{{ url_for('reporte_ventas_csv') }}">â¬‡ Descargar reporte de ventas (CSV)</a>
        <a class="reports__btn" href="{{ url_for('reporte_inventario_csv') }}">â¬‡ Descargar reporte de inventario (CSV)</a>
      </div>

      <div class="muted" style="margin-top:10px;">
        * Ventas: se toma de Caja â†’ ingresos cuyo motivo contenga â€œventaâ€.
      </div>
    </div>
  </div>
</div>

{% endblock %}

